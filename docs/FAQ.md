# WQS IoT Gateway 常见问题解答（FAQ）

## 目录

- [安装部署](#安装部署)
- [设备连接](#设备连接)
- [产品配置](#产品配置)
- [规则引擎](#规则引擎)
- [数据采集](#数据采集)
- [系统管理](#系统管理)
- [性能优化](#性能优化)
- [故障排查](#故障排查)

---

## 安装部署

### Q1: 系统支持哪些操作系统？

**A:** 系统支持以下操作系统：
- **Windows**: Windows 10/11, Windows Server 2016+
- **Linux**: CentOS 7+, Ubuntu 18.04+, Debian 9+
- **macOS**: 10.15+（仅用于开发环境）

推荐在生产环境使用 Linux 系统以获得更好的性能和稳定性。

### Q2: 数据库必须使用 MySQL 吗？

**A:** 是的，当前版本仅支持 MySQL 5.7 和 8.0。后续版本可能会支持其他数据库。

MySQL 5.7 和 8.0 的主要区别：
- MySQL 8.0 性能更好
- MySQL 8.0 默认使用 `caching_sha2_password` 认证插件
- 建议新项目使用 MySQL 8.0

### Q3: Redis 可以不安装吗？

**A:** 不可以。Redis 是必需组件，用于：
- 用户会话管理
- 缓存热点数据
- 分布式锁
- 实时数据缓存

### Q4: 启动后无法访问接口文档？

**A:** 检查以下几点：

1. **服务是否正常启动**
   ```bash
   # 查看日志
   tail -f logs/app.log
   ```

2. **端口是否被占用**
   ```bash
   # Windows
   netstat -ano | findstr :82
   
   # Linux
   lsof -i:82
   ```

3. **防火墙是否开放**
   ```bash
   # Linux
   sudo firewall-cmd --add-port=82/tcp --permanent
   sudo firewall-cmd --reload
   ```

4. **访问地址是否正确**
   - 本地访问：`http://localhost:82/doc.html`
   - 远程访问：`http://服务器IP:82/doc.html`

### Q5: Flyway 数据库迁移失败怎么办？

**A:** 常见原因和解决方法：

**错误1：Checksum mismatch**
```sql
-- 解决方法：修复或删除问题版本记录
UPDATE flyway_schema_history SET checksum = NULL WHERE version = '版本号';
-- 或
DELETE FROM flyway_schema_history WHERE version = '版本号';
```

**错误2：Migration script missing**
- 确保 `src/main/resources/db/migration` 目录下有完整的迁移脚本
- 检查文件命名格式：`V版本号__描述.sql`

**错误3：Baseline not applied**
```bash
# 重新设置 baseline
mvn flyway:baseline -Dflyway.baselineVersion=1
```

---

## 设备连接

### Q6: 设备一直显示离线怎么办？

**A:** 按以下步骤排查：

**步骤1：网络连通性检查**
```bash
# 测试网络连接
ping 设备IP地址

# 测试端口连接（以 Modbus TCP 502 端口为例）
telnet 设备IP 502
```

**步骤2：设备地址配置检查**
- 确认 IP 地址、端口号无误
- Modbus 检查从站地址（1-247）
- S7 检查机架号、插槽号
- 串口检查端口号、波特率、校验位

**步骤3：协议配置检查**
- 确认协议类型选择正确
- 检查字节序设置（大端/小端）
- 验证功能码和寄存器地址

**步骤4：查看通信日志**
```bash
# 查看设备通信日志
grep "设备名称" logs/app.log | grep "ERROR"
```

**步骤5：设备侧检查**
- 设备是否通电正常
- 设备网络配置是否正确
- 设备是否支持远程访问
- 防火墙是否拦截

### Q7: Modbus TCP 和 Modbus RTU 有什么区别？

**A:** 主要区别：

| 特性 | Modbus TCP | Modbus RTU |
|------|-----------|------------|
| 传输介质 | 以太网 | 串口（RS232/RS485） |
| 连接方式 | IP地址+端口 | 串口号+波特率 |
| 速度 | 快（100Mbps+） | 慢（9600-115200bps） |
| 距离 | 远（取决于网络） | 近（≤1200米） |
| 设备数量 | 多（无限制） | 少（≤247） |
| 适用场景 | 现代工厂 | 老旧设备 |

### Q8: S7 协议连接西门子 PLC 失败？

**A:** 检查以下配置：

**PLC 侧配置**
1. 允许 PUT/GET 通信
2. 开启 S7 通信端口（默认 102）
3. 确认机架号和插槽号
4. 检查 DB 块是否存在
5. DB 块是否允许优化（建议关闭）

**网关侧配置**
```
主机地址: PLC的IP地址
端口: 102
机架号: 0（通常）
插槽号: 1（S7-300/400）或 2（S7-1200/1500）
```

**测试连接**
```bash
# 使用 S7 测试工具验证连接
```

### Q9: BACnet 设备如何配置？

**A:** BACnet 配置要点：

**获取设备信息**
1. 使用 BACnet 扫描工具发现设备
2. 记录设备实例编号
3. 确认对象类型和实例

**配置示例**
```
主机地址: 192.168.1.100
端口: 47808
设备实例: 1001
对象类型: Analog Input (AI)
对象实例: 0
属性: Present_Value
```

**常见对象类型**
- AI (Analog Input): 模拟量输入
- AO (Analog Output): 模拟量输出
- BI (Binary Input): 数字量输入
- BO (Binary Output): 数字量输出

---

## 产品配置

### Q10: 如何理解产品和设备的关系？

**A:** 
- **产品** = 设备类型的模板
  - 定义物模型（属性、命令、报警）
  - 定义协议映射（寄存器地址）
  - 一个产品可以对应多个设备
  
- **设备** = 产品的实例
  - 继承产品的物模型
  - 有自己的设备地址
  - 可以采集和控制

**类比**：产品是"温湿度传感器型号A"，设备是"1号车间的具体传感器"。

### Q11: 寄存器映射怎么配置？

**A:** 配置步骤：

**步骤1：查阅设备协议文档**
```
示例：温湿度传感器
- 温度: 功能码03, 地址0, 16位有符号整数, 单位0.1℃
- 湿度: 功能码03, 地址1, 16位无符号整数, 单位0.1%
```

**步骤2：在产品中创建属性**
- 温度属性: temperature, 浮点型
- 湿度属性: humidity, 浮点型

**步骤3：配置寄存器映射**
```
温度属性:
  功能码: 03 (Read Holding Registers)
  起始地址: 0
  数据类型: 16位有符号整数
  字节序: 大端
  缩放比例: 0.1 (如果设备返回230，实际值为23.0℃)

湿度属性:
  功能码: 03
  起始地址: 1
  数据类型: 16位无符号整数
  字节序: 大端
  缩放比例: 0.1
```

**步骤4：测试验证**
- 添加测试设备
- 查看实时数据是否正确
- 验证数据单位和精度

### Q12: 数据类型如何选择？

**A:** 常见数据类型对照：

| 物模型类型 | Modbus 寄存器类型 | S7 数据类型 | 说明 |
|-----------|------------------|------------|------|
| 整型 | 16位整数 | INT | -32768~32767 |
| 整型 | 32位整数 | DINT | -2147483648~2147483647 |
| 浮点型 | 32位浮点数 | REAL | 单精度浮点 |
| 布尔型 | 线圈 | BOOL | true/false |
| 字符串 | 多个寄存器 | STRING | 文本 |

**选择原则**：
1. 参考设备协议文档
2. 考虑数据精度要求
3. 注意数值范围
4. 确认字节序

### Q13: 字节序如何确定？

**A:** 

**字节序类型**
- **大端（Big Endian）**: 高字节在前
- **小端（Little Endian）**: 低字节在前

**判断方法**
1. 查看设备手册
2. 读取已知数值进行对比
3. 测试两种字节序，看哪个结果正确

**示例**
```
寄存器值: 0x1234
- 大端解析: 4660 (0x1234)
- 小端解析: 13330 (0x3412)
```

**常见规律**
- 西门子 S7: 通常大端
- 施耐德: 通常大端
- 部分国产设备: 可能小端

---

## 规则引擎

### Q14: 规则不执行，怎么排查？

**A:** 按以下顺序检查：

**检查1：规则状态**
- 规则是否启用？
- 完整性状态是否正常？

**检查2：触发器配置**
- 设备是否在线？
- 触发属性是否有数据？
- 定时触发的 Cron 表达式是否正确？

**检查3：条件判断**
- 条件是否满足？
- 设备继承是否正确？
- 阈值设置是否合理？

**检查4：查看执行日志**
```
进入：规则引擎 > 规则管理 > 规则日志
筛选：失败记录
查看：错误原因
```

**检查5：查看系统日志**
```bash
grep "规则引擎" logs/app.log | grep "ERROR"
```

### Q15: 如何测试规则是否正确？

**A:** 测试步骤：

**方法1：使用模拟数据**
1. 先禁用规则
2. 手动修改设备数据
3. 观察是否满足触发条件
4. 启用规则测试

**方法2：使用测试模式**
1. 创建测试规则（独立于生产规则）
2. 使用测试设备
3. 验证规则逻辑
4. 通过后应用到生产环境

**方法3：查看日志追踪**
1. 触发规则
2. 查看执行日志
3. 验证每个节点的执行情况
4. 确认数据流转正确

### Q16: 条件组的 AND 和 OR 怎么理解？

**A:** 

**AND（且）- 所有条件必须满足**
```
条件组 (AND):
  ├─ 温度 > 30℃
  ├─ 湿度 < 40%
  └─ 时间 8:00-18:00

结果：只有三个条件都满足才执行
```

**OR（或）- 任一条件满足即可**
```
条件组 (OR):
  ├─ 温度 > 35℃
  ├─ 湿度 < 30%
  └─ CO2 > 1000ppm

结果：任何一个条件满足就执行
```

**嵌套使用**
```
条件组 (AND):
  ├─ 工作时间 (8:00-18:00)
  └─ 条件组 (OR):
      ├─ 温度 > 30℃
      └─ 湿度 < 40%

结果：必须是工作时间，且温度或湿度异常
```

### Q17: 设备继承功能如何使用？

**A:** 

**设备继承说明**
- **继承模式**：自动使用上游触发器的设备
- **指定模式**：手动选择具体设备

**使用场景**
```
场景1：单设备监控控制
触发器: 温度传感器A
  ↓ (自动继承)
条件: 温度 > 30℃
  ↓
动作: 控制传感器A所在空间的空调

场景2：跨设备联动
触发器: 温度传感器A
  ↓
条件: 温度 > 30℃
  ↓
动作: 控制设备B（空调）← 指定模式
```

**优势**
1. 简化配置
2. 避免设备选择错误
3. 确保数据上下文一致
4. 便于规则维护

### Q18: 完整性检查提示问题怎么办？

**A:** 常见问题和解决方法：

| 问题提示 | 原因 | 解决方法 |
|---------|------|---------|
| 缺少触发器节点 | 没有添加触发器 | 添加设备触发或定时触发 |
| 缺少动作节点 | 没有添加动作 | 添加设备控制或数据上报 |
| 触发器未选择设备 | 设备触发器没有配置设备 | 选择触发设备 |
| 条件未选择属性 | 简单条件没有配置属性 | 选择判断属性 |
| 条件未设置阈值 | 条件值为空 | 填写比较值 |
| 动作未选择设备 | 设备控制没有选择目标设备 | 选择控制设备 |
| 节点没有连接 | 存在孤立节点 | 建立节点连线 |

**保存策略**
- 配置完整：直接保存
- 配置不完整：可以保存但规则不会执行
- 建议：完整性检查通过后再启用规则

---

## 数据采集

### Q19: 数据显示不正确怎么办？

**A:** 排查步骤：

**步骤1：验证原始数据**
```bash
# 使用 Modbus 调试工具读取原始寄存器值
# 对比网关显示值和原始值
```

**步骤2：检查数据类型**
- 确认寄存器数据类型配置正确
- 验证有符号/无符号设置
- 检查数据长度（16位/32位）

**步骤3：检查字节序**
- 尝试切换大端/小端
- 对比已知正确值

**步骤4：检查缩放比例**
```
示例：
设备返回: 235
缩放比例: 0.1
显示值: 23.5℃
```

**步骤5：查看解析日志**
```bash
grep "数据解析" logs/app.log
```

### Q20: 如何设置数据采集频率？

**A:** 

**设置方法**
1. 产品配置中设置默认采集周期
2. 设备配置中可以覆盖产品设置
3. 单位：秒

**建议值**
- **温湿度传感器**: 30-60秒
- **电表数据**: 60-300秒
- **水表数据**: 300-600秒
- **关键设备**: 5-10秒
- **报警信号**: 1-5秒

**注意事项**
- 频率过高：增加网络负载，影响设备寿命
- 频率过低：可能错过重要数据变化
- 根据业务需求和设备性能平衡

### Q21: 历史数据保存多久？

**A:** 

**默认配置**
- 实时数据：永久保存（除非手动删除）
- 历史数据：根据数据库容量

**数据清理策略**
```sql
-- 手动清理90天前的数据
DELETE FROM iot_device_data WHERE create_time < DATE_SUB(NOW(), INTERVAL 90 DAY);
```

**配置定时清理**
```bash
# 添加到 crontab
0 2 * * * /path/to/cleanup_old_data.sh
```

**数据归档建议**
1. 定期导出重要数据
2. 保留原始数据样本
3. 使用数据压缩
4. 考虑使用时序数据库

---

## 系统管理

### Q22: 忘记超级管理员密码怎么办？

**A:** 

**方法1：通过数据库重置**
```sql
-- 重置密码为 123456
UPDATE sys_user 
SET password = '$2a$10$...' -- BCrypt加密后的值
WHERE account = 'superAdmin';
```

**方法2：使用重置工具**
```bash
java -jar password-reset-tool.jar
```

**方法3：重新初始化**
- 备份数据库
- 清空用户表
- 重启服务自动创建默认账号

**安全建议**
- 首次登录立即修改密码
- 使用强密码
- 定期更换密码
- 不要共享管理员账号

### Q23: 如何设置用户权限？

**A:** 

**权限体系**
```
用户 → 角色 → 权限
```

**配置步骤**

**步骤1：创建角色**
```
角色名称: 设备管理员
角色权限:
  ✓ 产品管理
  ✓ 设备管理
  ✓ 数据查询
  ✗ 规则引擎
  ✗ 系统管理
```

**步骤2：分配用户**
```
用户: 张三
角色: 设备管理员
```

**推荐角色划分**
- **超级管理员**: 所有权限
- **设备管理员**: 设备相关操作
- **规则管理员**: 规则配置
- **运维人员**: 监控和日志
- **查看用户**: 只读权限

### Q24: 多个用户同时修改配置会冲突吗？

**A:** 

**现状**：后修改的会覆盖先修改的

**避免冲突的方法**
1. 明确分工，避免同时编辑
2. 使用不同的配置模块
3. 重要修改前通知团队
4. 定期备份配置

**未来改进**
- 配置版本管理
- 修改冲突检测
- 配置锁定机制

---

## 性能优化

### Q25: 系统运行缓慢怎么办？

**A:** 优化建议：

**1. 数据库优化**
```sql
-- 添加索引
CREATE INDEX idx_device_id ON iot_device_data(device_id);
CREATE INDEX idx_create_time ON iot_device_data(create_time);

-- 清理旧数据
DELETE FROM iot_device_data WHERE create_time < DATE_SUB(NOW(), INTERVAL 90 DAY);

-- 优化表
OPTIMIZE TABLE iot_device_data;
```

**2. Redis 优化**
```yaml
spring:
  redis:
    lettuce:
      pool:
        max-active: 50
        max-idle: 20
```

**3. JVM 调优**
```bash
java -Xms4g -Xmx8g -XX:+UseG1GC -jar app.jar
```

**4. 采集频率优化**
- 降低非关键设备的采集频率
- 批量读取多个寄存器
- 使用数据变化触发而非周期轮询

**5. 规则优化**
- 简化复杂规则
- 避免嵌套过深的条件组
- 合并相似规则

### Q26: 如何监控系统性能？

**A:** 

**内置监控**
- Spring Boot Actuator
- 访问: `http://localhost:82/actuator`

**推荐工具**
1. **Prometheus + Grafana**: 性能指标监控
2. **ELK Stack**: 日志分析
3. **Arthas**: Java 应用诊断

**关键指标**
- CPU 使用率
- 内存使用率
- 数据库连接数
- Redis 连接数
- 接口响应时间
- 设备在线率

---

## 故障排查

### Q27: 服务突然停止运行？

**A:** 排查步骤：

**步骤1：查看进程**
```bash
# Linux
ps aux | grep java

# Windows
tasklist | findstr java
```

**步骤2：查看日志**
```bash
# 查看错误日志
tail -100 logs/app.log | grep ERROR

# 查看系统日志
journalctl -u iot-gateway -n 100
```

**步骤3：常见原因**
- 内存溢出（OutOfMemoryError）
- 数据库连接池耗尽
- Redis 连接失败
- 端口被占用
- 磁盘空间不足

**步骤4：恢复服务**
```bash
# 重启服务
sudo systemctl restart iot-gateway

# 或
java -jar app.jar
```

### Q28: 数据突然不更新了？

**A:** 

**可能原因**
1. 设备离线
2. 网络中断
3. 采集任务异常
4. 数据库写入失败

**排查方法**
```bash
# 1. 检查设备状态
# 在设备管理页面查看设备在线状态

# 2. 测试网络
ping 设备IP

# 3. 查看采集日志
grep "数据采集" logs/app.log | tail -50

# 4. 检查数据库
mysql -u root -p -e "SELECT COUNT(*) FROM iot_device_data WHERE create_time > NOW() - INTERVAL 1 HOUR;"
```

### Q29: 内存占用过高？

**A:** 

**诊断方法**
```bash
# 查看 JVM 内存
jmap -heap <pid>

# 生成内存快照
jmap -dump:format=b,file=heap.hprof <pid>

# 使用 MAT 工具分析快照
```

**优化方法**
1. 调整 JVM 参数
2. 清理历史数据
3. 优化缓存策略
4. 检查内存泄漏

### Q30: 如何备份和恢复数据？

**A:** 

**数据库备份**
```bash
# 备份
mysqldump -u root -p iot_gateway > backup_$(date +%Y%m%d).sql

# 恢复
mysql -u root -p iot_gateway < backup_20260111.sql
```

**配置备份**
```bash
# 导出产品配置
# 导出设备配置
# 导出规则配置
# 下载备份文件
```

**完整备份**
```bash
#!/bin/bash
# 备份脚本
DATE=$(date +%Y%m%d)
BACKUP_DIR=/backup/$DATE

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u root -p iot_gateway > $BACKUP_DIR/database.sql

# 备份配置文件
cp application.yml $BACKUP_DIR/

# 备份日志
cp -r logs $BACKUP_DIR/

# 打包
tar -czf backup_$DATE.tar.gz $BACKUP_DIR
```

**自动备份**
```bash
# 添加到 crontab
0 2 * * * /path/to/backup.sh
```

---

## 联系支持

如果以上FAQ无法解决您的问题，请：

1. **查看详细文档**
   - [部署指南](./部署指南.md)
   - [使用指南](./使用指南.md)

2. **查看系统日志**
   ```bash
   tail -100 logs/app.log
   ```

3. **收集问题信息**
   - 问题描述
   - 操作步骤
   - 错误截图
   - 日志信息
   - 系统环境

4. **联系技术支持**
   - 提交 Issue
   - 发送邮件
   - 在线咨询

---

**文档版本**: 1.0  
**最后更新**: 2026-01-11  
**持续更新中...**

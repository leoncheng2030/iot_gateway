# WQS IoT Gateway 使用指南

## 快速开始

### 登录系统

1. 访问系统地址：`http://your-domain.com`
2. 输入用户名和密码
3. 首次登录建议修改密码

默认超级管理员账号：
- 用户名：`superAdmin`
- 密码：`123456`

### 界面概览

系统采用左侧菜单导航结构：

```
├── 首页 - 系统概览和数据统计
├── 设备管理
│   ├── 产品管理 - 定义产品物模型
│   └── 设备管理 - 管理具体设备
├── 规则引擎
│   ├── 规则管理 - 配置自动化规则
│   └── 执行日志 - 查看规则执行记录
├── 系统管理
│   ├── 用户管理
│   ├── 角色管理
│   └── 权限管理
└── 开发管理
    └── 配置管理
```

## 产品管理

### 创建产品

产品是一类设备的模板，定义了设备的物模型和协议配置。

#### 1. 新建产品

1. 进入 **设备管理 > 产品管理**
2. 点击 **新增** 按钮
3. 填写产品信息：
   - **产品名称**：例如"温湿度传感器"
   - **产品标识**：唯一标识，如"TH_SENSOR_01"
   - **协议类型**：选择 Modbus TCP、Modbus RTU、S7、BACnet 等
   - **产品描述**：产品的详细说明
4. 点击 **保存**

#### 2. 配置物模型

物模型定义设备的属性、命令和报警。

**添加属性**

1. 在产品列表中点击 **物模型** 按钮
2. 切换到 **属性** 标签页
3. 点击 **新增属性**
4. 填写属性信息：
   - **属性名称**：如"温度"
   - **属性标识**：如"temperature"
   - **数据类型**：整型、浮点型、字符串等
   - **单位**：如"℃"
   - **读写类型**：只读、读写
   - **属性描述**：详细说明
5. 点击 **保存**

**添加命令**

1. 切换到 **命令** 标签页
2. 点击 **新增命令**
3. 填写命令信息：
   - **命令名称**：如"开关控制"
   - **命令标识**：如"switch"
   - **命令类型**：控制、查询
   - **参数定义**：JSON 格式定义命令参数
4. 点击 **保存**

**添加报警**

1. 切换到 **报警** 标签页
2. 点击 **新增报警**
3. 填写报警信息：
   - **报警名称**：如"温度过高"
   - **报警标识**：如"temp_high"
   - **报警级别**：提示、警告、严重
   - **报警条件**：触发条件表达式
4. 点击 **保存**

#### 3. 配置寄存器映射

寄存器映射定义协议地址与物模型属性的对应关系。

1. 在产品详情页面，切换到 **寄存器映射** 标签页
2. 点击 **新增映射**
3. 选择要映射的 **属性**
4. 配置寄存器信息：
   - **Modbus 协议**：
     - 功能码：03（读保持寄存器）、04（读输入寄存器）等
     - 起始地址：如 0、100
     - 数据类型：16位整数、32位浮点数等
     - 字节序：大端、小端
   - **S7 协议**：
     - 存储区：DB、M、I、Q 等
     - DB 编号：如 1
     - 起始地址：如 0
     - 数据类型：BOOL、INT、REAL 等
   - **BACnet 协议**：
     - 对象类型：AI、AO、BI、BO 等
     - 对象实例：如 0
     - 属性标识：Present_Value 等
5. 点击 **保存**

**配置示例（Modbus 温湿度传感器）**

| 属性 | 功能码 | 地址 | 数据类型 | 字节序 |
|------|--------|------|----------|--------|
| 温度 | 03 | 0 | 16位有符号整数 | 大端 |
| 湿度 | 03 | 1 | 16位无符号整数 | 大端 |

## 设备管理

### 添加设备

1. 进入 **设备管理 > 设备管理**
2. 点击 **新增** 按钮
3. 填写设备信息：
   - **设备名称**：如"1号车间温湿度传感器"
   - **设备编号**：唯一标识
   - **所属产品**：选择已创建的产品
   - **设备描述**：设备位置、用途等
4. 配置设备地址：
   - **Modbus TCP**：
     - 主机地址：如 192.168.1.100
     - 端口：默认 502
     - 从站地址：1-247
   - **Modbus RTU**：
     - 串口端口：如 COM1
     - 波特率：9600、19200 等
     - 数据位：8
     - 停止位：1
     - 校验位：无、奇、偶
     - 从站地址：1-247
   - **S7 协议**：
     - 主机地址：PLC IP地址
     - 端口：默认 102
     - 机架号：0
     - 插槽号：1
   - **BACnet**：
     - 主机地址：设备 IP 地址
     - 端口：默认 47808
     - 设备实例：设备编号
5. 点击 **保存**

### 设备状态监控

1. 在设备列表中查看设备状态：
   - 🟢 **在线**：设备正常通信
   - 🔴 **离线**：设备无法连接
2. 点击设备名称进入设备详情页
3. 查看设备实时数据和历史数据

### 设备控制

1. 进入设备详情页
2. 切换到 **控制** 标签页
3. 选择要执行的命令
4. 填写命令参数
5. 点击 **执行** 按钮
6. 查看执行结果

### 批量操作

**批量导入设备**

1. 点击 **导入** 按钮
2. 下载设备导入模板
3. 按模板格式填写设备信息
4. 上传 Excel 文件
5. 查看导入结果

**批量导出设备**

1. 勾选要导出的设备（不勾选则导出全部）
2. 点击 **导出** 按钮
3. 下载 Excel 文件

## 规则引擎

规则引擎用于配置设备自动化控制规则，实现设备间的联动。

### 创建规则

1. 进入 **规则引擎 > 规则管理**
2. 点击 **新增** 按钮
3. 填写规则基本信息：
   - **规则名称**：如"温度过高启动风扇"
   - **规则类型**：设备联动、数据上报等
   - **规则描述**：详细说明
   - **状态**：启用/禁用
4. 点击 **保存**
5. 点击 **规则编排** 进入流程设计

### 规则编排

规则编排采用可视化流程设计，由触发器、条件、动作三部分组成。

#### 1. 添加触发器

触发器定义规则的启动条件。

1. 点击画布上的 **添加节点** 或从左侧拖拽触发器节点
2. 配置触发器：
   - **触发类型**：设备触发、定时触发
   - **设备触发**：
     - 选择设备
     - 选择触发属性（如温度）
     - 设置触发方式（数据变化、周期上报）
   - **定时触发**：
     - Cron 表达式：如 `0 0 * * * ?`（每小时）
3. 点击 **确定**

#### 2. 添加条件判断

条件判断节点用于判断是否满足执行条件。

**简单条件**

1. 从触发器连线添加条件节点
2. 配置条件：
   - **设备来源**：继承（自动使用上游设备）、指定
   - **属性**：选择要判断的属性（如温度）
   - **操作符**：>、<、=、>=、<=、!=
   - **阈值**：如 30
3. 点击 **确定**

示例：温度 > 30℃

**条件组（复杂条件）**

1. 添加条件组节点
2. 选择逻辑关系：AND（且）、OR（或）
3. 添加多个子条件
4. 点击 **确定**

示例：温度 > 30℃ AND 湿度 < 40%

#### 3. 添加动作

动作节点定义满足条件后要执行的操作。

1. 从条件节点连线添加动作节点
2. 配置动作：
   - **动作类型**：设备控制、数据上报、消息通知
   - **设备控制**：
     - 选择目标设备
     - 选择控制命令
     - 填写命令参数
   - **数据上报**：
     - 选择上报平台
     - 配置上报数据格式
3. 点击 **确定**

#### 4. 完整性检查

保存前系统会自动检查规则完整性：

- ✅ 检查是否有触发器
- ✅ 检查是否有动作
- ✅ 检查触发器配置是否完整
- ✅ 检查条件配置是否完整
- ✅ 检查动作配置是否完整
- ✅ 检查节点连接是否完整

如果检查不通过，会显示具体问题列表，可以选择继续保存或返回修改。

### 规则示例

**示例1：温度过高自动降温**

```
触发器：1号温湿度传感器
  ↓
条件判断：温度 > 30℃
  ↓
动作：开启空调（设置温度26℃）
```

**示例2：多条件联动**

```
触发器：环境监测传感器
  ↓
条件组（AND）：
  - 温度 > 30℃
  - 湿度 < 40%
  - 时间段：工作时间（8:00-18:00）
  ↓
动作组：
  - 开启加湿器
  - 开启空调
  - 发送告警通知
```

**示例3：设备异常告警**

```
触发器：设备状态变化
  ↓
条件判断：设备状态 = 离线
  ↓
动作：发送短信/邮件通知管理员
```

### 规则管理

**启用/禁用规则**

1. 在规则列表中找到目标规则
2. 点击状态开关切换启用/禁用

**编辑规则**

1. 点击规则的 **编辑** 按钮
2. 修改规则信息或流程
3. 保存并再次检查完整性

**删除规则**

1. 点击规则的 **删除** 按钮
2. 确认删除操作

**查看执行日志**

1. 点击规则的 **规则日志** 按钮
2. 查看规则执行历史
3. 筛选执行状态：成功、失败
4. 查看详细执行信息和错误原因

## 数据查询

### 实时数据

1. 进入 **设备管理 > 设备管理**
2. 点击设备名称进入详情页
3. 查看设备当前数据
4. 数据自动刷新（可配置刷新间隔）

### 历史数据

1. 在设备详情页切换到 **历史数据** 标签页
2. 选择查询条件：
   - 时间范围：最近1小时、24小时、自定义
   - 属性筛选：选择要查询的属性
3. 点击 **查询** 按钮
4. 查看数据列表或图表展示

### 数据导出

1. 在历史数据页面查询数据
2. 点击 **导出** 按钮
3. 选择导出格式：Excel、CSV
4. 下载导出文件

## 系统管理

### 用户管理

**添加用户**

1. 进入 **系统管理 > 用户管理**
2. 点击 **新增** 按钮
3. 填写用户信息：
   - 用户名、密码
   - 姓名、手机、邮箱
   - 所属角色
   - 状态（启用/禁用）
4. 点击 **保存**

**修改密码**

1. 点击用户的 **编辑** 按钮
2. 点击 **重置密码** 按钮
3. 输入新密码
4. 点击 **确定**

### 角色管理

**创建角色**

1. 进入 **系统管理 > 角色管理**
2. 点击 **新增** 按钮
3. 填写角色信息：
   - 角色名称：如"设备管理员"
   - 角色标识：如"device_admin"
   - 角色描述
4. 配置角色权限：勾选菜单和按钮权限
5. 点击 **保存**

**推荐角色配置**

| 角色 | 权限范围 |
|------|----------|
| 超级管理员 | 所有权限 |
| 设备管理员 | 产品管理、设备管理、数据查询 |
| 规则管理员 | 规则引擎、执行日志 |
| 运维人员 | 系统监控、日志查询 |
| 普通用户 | 数据查询（只读） |

## 最佳实践

### 1. 产品设计

- 按设备类型创建产品，而不是按设备创建
- 物模型属性命名使用小写字母加下划线
- 合理规划寄存器地址，避免冲突
- 为每个属性添加详细的描述信息

### 2. 设备管理

- 设备命名规范：位置+设备类型+编号
- 定期检查设备在线状态
- 及时处理设备告警
- 建立设备维护档案

### 3. 规则设计

- 规则命名要清晰表达业务逻辑
- 避免创建过于复杂的条件组
- 及时查看规则执行日志
- 定期审查和优化规则性能
- 测试规则时先禁用，验证无误后再启用

### 4. 数据管理

- 合理设置数据采集频率
- 定期清理历史数据
- 重要数据及时导出备份
- 建立数据监控和告警机制

### 5. 安全管理

- 定期修改密码
- 合理分配用户权限
- 定期审查用户登录日志
- 重要操作设置二次确认

## 常见问题

### 1. 设备离线怎么办？

**排查步骤**：
1. 检查设备是否通电
2. 检查网络连接是否正常
3. ping 设备 IP 地址测试网络
4. 检查设备地址配置是否正确
5. 查看设备通信日志
6. 检查防火墙是否拦截

### 2. 规则不执行？

**排查步骤**：
1. 检查规则状态是否启用
2. 检查完整性状态是否有问题
3. 查看规则执行日志
4. 检查触发条件是否满足
5. 检查设备是否在线
6. 验证设备数据是否正常

### 3. 数据显示异常？

**可能原因**：
- 寄存器映射配置错误
- 数据类型设置不正确
- 字节序配置错误
- 设备数据格式变更

**解决方法**：
1. 重新检查寄存器映射配置
2. 使用调试工具验证原始数据
3. 对比产品文档确认数据格式
4. 联系设备厂商确认协议

### 4. 如何备份配置？

1. 导出所有产品配置
2. 导出所有设备配置
3. 导出所有规则配置
4. 备份数据库（推荐）

### 5. 忘记密码怎么办？

**超级管理员密码重置**：
1. 联系系统管理员
2. 通过数据库直接修改
3. 使用密码重置功能

**普通用户密码重置**：
1. 联系管理员重置
2. 使用忘记密码功能（需配置邮箱）

## 技术支持

如遇到问题无法解决，请：

1. 查看系统日志获取详细错误信息
2. 查阅在线文档
3. 联系技术支持团队
4. 提交问题时请提供：
   - 问题描述
   - 操作步骤
   - 错误截图
   - 日志信息

---

更多功能持续更新中，敬请期待！

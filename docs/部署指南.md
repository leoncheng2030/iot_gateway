# WQS IoT Gateway 部署指南

## 环境要求

### 硬件要求

| 配置项 | 最低配置 | 推荐配置 |
|--------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 硬盘 | 20GB | 50GB+ SSD |
| 网络 | 100Mbps | 1Gbps |

### 软件环境

| 组件 | 版本要求 | 说明 |
|------|----------|------|
| 操作系统 | Windows/Linux/macOS | 建议使用 Linux 生产环境 |
| JDK | 17 | 必须，后端运行环境 |
| Node.js | ≥ 18 | 必须，前端构建环境 |
| Maven | 最新版 | 必须，依赖管理工具 |
| MySQL | 8.0 / 5.7 | 必须，数据存储 |
| Redis | 最新版 | 必须，缓存服务 |

## 快速部署

### 1. 数据库准备

#### 1.1 安装 MySQL

**Windows 环境**
```bash
# 下载 MySQL 8.0 安装包并安装
# 配置环境变量
```

**Linux 环境**
```bash
# CentOS/RHEL
sudo yum install mysql-server

# Ubuntu/Debian
sudo apt-get install mysql-server

# 启动服务
sudo systemctl start mysql
sudo systemctl enable mysql
```

#### 1.2 创建数据库

```sql
-- 创建数据库
CREATE DATABASE iot_gateway DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户（可选）
CREATE USER 'iot_user'@'%' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON iot_gateway.* TO 'iot_user'@'%';
FLUSH PRIVILEGES;
```

#### 1.3 导入初始化脚本

数据库表会在首次启动时通过 Flyway 自动创建，无需手动导入。

### 2. Redis 安装

**Windows 环境**
```bash
# 下载 Redis for Windows
# 解压并运行 redis-server.exe
```

**Linux 环境**
```bash
# CentOS/RHEL
sudo yum install redis

# Ubuntu/Debian
sudo apt-get install redis-server

# 启动服务
sudo systemctl start redis
sudo systemctl enable redis
```

### 3. 后端部署

#### 3.1 克隆代码

```bash
git clone <repository-url>
cd iot_gateway
```

#### 3.2 配置文件

编辑 `snowy-web-app/src/main/resources/application.yml`：

```yaml
server:
  port: 82

spring:
  # 数据库配置
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/iot_gateway?useUnicode=true&characterEncoding=utf-8&useSSL=false&serverTimezone=GMT%2B8&allowPublicKeyRetrieval=true
    username: root
    password: your_password
    
  # Redis 配置
  redis:
    host: localhost
    port: 6379
    password: 
    database: 0
```

#### 3.3 编译打包

```bash
# 编译整个项目
mvn clean package -DskipTests

# 打包后的 jar 文件位于
# snowy-web-app/target/snowy-web-app.jar
```

#### 3.4 启动服务

**开发环境**
```bash
# 在 IDE 中直接运行 snowy-web-app 模块的主类
# vip.xiaonuo.app.SnowyApplication
```

**生产环境**
```bash
# 方式一：直接运行
java -jar snowy-web-app/target/snowy-web-app.jar

# 方式二：后台运行
nohup java -jar snowy-web-app/target/snowy-web-app.jar > logs/app.log 2>&1 &

# 方式三：使用 systemd（推荐）
sudo systemctl start iot-gateway
```

#### 3.5 验证服务

访问接口文档：`http://localhost:82/doc.html`

默认账号：
- 用户名：superAdmin
- 密码：123456

### 4. 前端部署

#### 4.1 安装依赖

```bash
cd snowy-admin-web
npm install
```

如果安装慢，可以使用国内镜像：
```bash
npm config set registry https://registry.npmmirror.com
npm install
```

#### 4.2 开发环境运行

```bash
npm run dev
```

访问地址：`http://localhost:5173`

#### 4.3 生产环境打包

```bash
# 打包构建
npm run build

# 打包后的文件位于 dist 目录
```

#### 4.4 部署到 Web 服务器

**使用 Nginx**

1. 将 `dist` 目录上传到服务器

2. 配置 Nginx：

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    root /path/to/dist;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # 后端接口代理
    location /api/ {
        proxy_pass http://localhost:82/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

3. 重启 Nginx：
```bash
sudo nginx -s reload
```

## Docker 容器化部署

### 1. 环境准备

**安装 Docker 和 Docker Compose**

**Linux 环境**
```bash
# 安装 Docker
curl -fsSL https://get.docker.com | sh

# 安装 Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker
```

**Windows 环境**
- 下载并安装 [Docker Desktop for Windows](https://www.docker.com/products/docker-desktop/)
- 安装完成后启动 Docker Desktop

### 2. 配置环境变量

在项目根目录创建 `.env` 文件，配置数据库密码等敏感信息：

```bash
# 复制环境变量模板
cp .env.example .env

# 编辑配置文件
vim .env
```

修改以下关键配置：
```properties
# 数据库密码（请使用强密码）
MYSQL_ROOT_PASSWORD=your_secure_root_password
MYSQL_PASSWORD=your_secure_database_password

# InfluxDB 配置
INFLUXDB_PASSWORD=your_secure_influxdb_password
INFLUXDB_TOKEN=your_secure_token_at_least_32_chars

# Redis 密码（可选）
REDIS_PASSWORD=your_redis_password
```

### 3. 一键启动

**启动所有服务**
```bash
# 构建并启动所有容器
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f
```

**首次启动说明**
- 首次启动需要构建镜像，耗时约 5-10 分钟
- 后端服务会自动初始化数据库表结构
- 等待所有服务健康检查通过

### 4. 访问应用

启动成功后，通过浏览器访问：

- **前端地址**：http://localhost:80
- **后端 API 文档**：http://localhost:82/doc.html
- **InfluxDB 控制台**：http://localhost:8086

**默认账号**
- 用户名：`superAdmin`
- 密码：`123456`

### 5. 常用管理命令

**启动服务**
```bash
# 启动所有服务
docker-compose start

# 启动指定服务
docker-compose start backend
```

**停止服务**
```bash
# 停止所有服务
docker-compose stop

# 停止并删除容器（不删除数据卷）
docker-compose down

# 停止并删除容器和数据卷（谨慎操作）
docker-compose down -v
```

**查看日志**
```bash
# 查看所有服务日志
docker-compose logs -f

# 查看指定服务日志
docker-compose logs -f backend
docker-compose logs -f frontend

# 查看最近 100 行日志
docker-compose logs --tail=100 backend
```

**重启服务**
```bash
# 重启所有服务
docker-compose restart

# 重启指定服务
docker-compose restart backend
```

**更新服务**
```bash
# 拉取最新代码后重新构建
git pull
docker-compose build
docker-compose up -d
```

### 6. 数据备份与恢复

**备份数据库**
```bash
# MySQL 备份
docker exec iot-gateway-mysql mysqldump -uroot -p${MYSQL_ROOT_PASSWORD} iot_gateway > backup_$(date +%Y%m%d).sql

# 备份数据卷
docker run --rm -v iot_gateway_mysql-data:/data -v $(pwd):/backup alpine tar czf /backup/mysql-data-backup.tar.gz -C /data .
```

**恢复数据库**
```bash
# MySQL 恢复
docker exec -i iot-gateway-mysql mysql -uroot -p${MYSQL_ROOT_PASSWORD} iot_gateway < backup.sql
```

### 7. 性能调优

**调整 JVM 内存**

在 `.env` 文件中修改：
```properties
JAVA_OPTS=-Xms1g -Xmx4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200
```

**调整 MySQL 连接数**

修改 `docker-compose.yml` 中的 MySQL 配置：
```yaml
command:
  - --max_connections=2000
```

### 8. 生产环境建议

1. **修改默认密码**：修改 `.env` 中的所有密码配置
2. **启用 HTTPS**：配置 SSL 证书和反向代理
3. **配置防火墙**：只开放必要端口（80、443）
4. **定期备份**：设置自动备份脚本
5. **监控告警**：集成监控系统（如 Prometheus + Grafana）
6. **资源限制**：在 docker-compose.yml 中配置资源限制

**资源限制示例**
```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G
```

### 9. 故障排查

**查看容器状态**
```bash
docker-compose ps
```

**进入容器调试**
```bash
# 进入后端容器
docker exec -it iot-gateway-backend sh

# 进入数据库容器
docker exec -it iot-gateway-mysql bash
```

**检查网络连接**
```bash
# 查看网络配置
docker network inspect iot_gateway_iot-network

# 测试容器间连接
docker exec iot-gateway-backend ping mysql
```

**重置数据库**
```bash
# 停止服务并删除数据卷
docker-compose down -v

# 重新启动（会自动初始化数据库）
docker-compose up -d
```

---

## 生产环境优化

### 1. JVM 参数调优

```bash
java -Xms2g -Xmx4g \
     -XX:+UseG1GC \
     -XX:MaxGCPauseMillis=200 \
     -XX:+HeapDumpOnOutOfMemoryError \
     -XX:HeapDumpPath=/logs/heapdump.hprof \
     -jar snowy-web-app.jar
```

### 2. 数据库连接池优化

```yaml
spring:
  datasource:
    hikari:
      minimum-idle: 10
      maximum-pool-size: 50
      connection-timeout: 30000
      idle-timeout: 600000
      max-lifetime: 1800000
```

### 3. Redis 连接池优化

```yaml
spring:
  redis:
    lettuce:
      pool:
        max-active: 50
        max-idle: 20
        min-idle: 10
        max-wait: 3000
```

### 4. 日志配置

编辑 `logback-spring.xml`，配置日志级别和输出：

```xml
<configuration>
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/app.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/app-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="FILE" />
    </root>
</configuration>
```

## 系统服务配置

### Systemd 服务配置（Linux）

创建服务文件 `/etc/systemd/system/iot-gateway.service`：

```ini
[Unit]
Description=IoT Gateway Platform
After=network.target

[Service]
Type=simple
User=iot
WorkingDirectory=/opt/iot-gateway
ExecStart=/usr/bin/java -jar /opt/iot-gateway/snowy-web-app.jar
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable iot-gateway
sudo systemctl start iot-gateway
sudo systemctl status iot-gateway
```

## 常见问题

### 1. 数据库连接失败

**问题**：`Communications link failure`

**解决方案**：
- 检查 MySQL 是否正常运行
- 确认数据库地址、端口、用户名、密码是否正确
- 检查防火墙是否放行 3306 端口

### 2. Redis 连接失败

**问题**：`Unable to connect to Redis`

**解决方案**：
- 检查 Redis 是否正常运行
- 确认 Redis 地址、端口、密码是否正确
- 检查 Redis 配置是否允许远程连接

### 3. 端口占用

**问题**：`Address already in use`

**解决方案**：
```bash
# 查看端口占用
netstat -ano | findstr :82  # Windows
lsof -i:82                   # Linux/macOS

# 修改配置文件中的端口号
```

### 4. 前端跨域问题

**解决方案**：
- 开发环境：在 `vite.config.js` 中配置代理
- 生产环境：使用 Nginx 反向代理

### 5. Flyway 数据库升级失败

**问题**：`Migration checksum mismatch`

**解决方案**：
```bash
# 清理 Flyway 历史记录（谨慎操作）
DELETE FROM flyway_schema_history WHERE version = 'problematic_version';

# 或修复校验和
UPDATE flyway_schema_history SET checksum = 'correct_checksum' WHERE version = 'version';
```

## 安全建议

1. **修改默认密码**：首次部署后立即修改超级管理员密码
2. **数据库安全**：不要使用 root 账户，创建专用数据库用户
3. **Redis 密码**：生产环境必须设置 Redis 密码
4. **HTTPS**：生产环境使用 HTTPS 协议
5. **防火墙**：只开放必要的端口（80/443）
6. **定期备份**：配置数据库定期备份

## 监控和维护

### 1. 日志监控

```bash
# 实时查看日志
tail -f logs/app.log

# 查看错误日志
grep "ERROR" logs/app.log
```

### 2. 性能监控

建议集成以下监控工具：
- Spring Boot Actuator
- Prometheus + Grafana
- ELK 日志分析

### 3. 数据备份

```bash
# MySQL 备份脚本
mysqldump -u root -p iot_gateway > backup_$(date +%Y%m%d).sql

# 设置定时任务
0 2 * * * /path/to/backup.sh
```

## 升级指南

### 1. 备份数据

```bash
# 备份数据库
mysqldump -u root -p iot_gateway > backup.sql

# 备份配置文件
cp application.yml application.yml.bak
```

### 2. 停止服务

```bash
sudo systemctl stop iot-gateway
```

### 3. 更新代码

```bash
git pull origin main
mvn clean package -DskipTests
```

### 4. 启动服务

```bash
sudo systemctl start iot-gateway
```

### 5. 验证升级

- 检查服务是否正常启动
- 检查日志是否有错误
- 测试核心功能是否正常

---

如有问题，请查看详细日志或联系技术支持。
